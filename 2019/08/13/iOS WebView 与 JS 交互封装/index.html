<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-xxxxxx-xx');
  </script>
  

  <!-- Baidu Tongji -->
  
  <script type="text/javascript">
    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  

  <!-- Baidu Push -->
  
  <script>
    (function() {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="jerod blog" />
  <meta name="keyword" content="jijiudong,jerod,jerodji,iOS,js,IT  blog,Blog" />
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../../../css/highlight.css">
<link rel="stylesheet" href="../../../../css/widget.css">
<link rel="stylesheet" href="../../../../css/rocket.css">
<link rel="stylesheet" href="../../../../css/signature.css">
<link rel="stylesheet" href="../../../../css/catalog.css">
<link rel="stylesheet" href="../../../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  
  <!-- gitalk start -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
  <link rel="stylesheet" href="/css/gitalk.css" />
  <!-- gitalk end -->
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/2019/08/13/iOS WebView 与 JS 交互封装/">
  <title>
    
    iOS WebView 与 JS 交互封装 - either thin | or die
    
  </title>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
	<!-- ThemeColor -->
	
	<!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

	

	<!-- Gitter -->
	
	<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

	

	<!-- Navigation (contains search)-->
	<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">吉久东的博客</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/about/">About</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


	<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('');
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/jerod-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#OC" title="OC">OC</a>
              
              <a class="tag" href="/tags/#JS" title="JS">JS</a>
              
              <a class="tag" href="/tags/#WebView" title="WebView">WebView</a>
              
            </div>
            <h1>iOS WebView 与 JS 交互封装</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by 吉久东 on
              2019-08-13
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">30</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">5.4k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- 不蒜子统计 start -->
            <span class="meta">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            <!-- WordCount end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



	<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
	<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>iOS UIWebView逐渐被淘汰, WKWebView成为主流. 本文封装了 WKJSWebView，参考<code>EasyJSWebView</code>的交互方式, 对其进行了修改和增加. 可以实现原生调用JS, 也可以JS调用原生.</p>
<h2 id="一-使用方法"><a href="#一-使用方法" class="headerlink" title="一. 使用方法"></a>一. 使用方法</h2><h3 id="JS调原生"><a href="#JS调原生" class="headerlink" title="JS调原生"></a>JS调原生</h3><ol>
<li>创建一个交互类, 定义给js的交互接口</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &quot;WKJSWebView.h&quot;</span><br><span class="line">@interface JSInterface : NSObject</span><br><span class="line">- (void)testWithParams:(NSString*)_params callback:(WKJSDataFunction*)_callback;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#import &quot;JSInterface.h&quot;</span><br><span class="line">#import &quot;MJExtension.h&quot;</span><br><span class="line">@implementation JSInterface</span><br><span class="line">- (void)testWithParams:(NSString*)_params callback:(WKJSDataFunction*)_callback</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;接收h5 参数</span><br><span class="line">    NSLog(@&quot;H5 调 native, 参数 : %@&quot;, _params);</span><br><span class="line">    </span><br><span class="line">    NSString *letter &#x3D; [NSString stringWithFormat:@&quot;%C&quot;, (unichar)(arc4random_uniform(26) + &#39;A&#39;)];</span><br><span class="line">    NSDictionary* p1 &#x3D; @&#123;@&quot;letter&quot;: letter, @&quot;b&quot;: @&quot;bb&quot;, @&quot;c&quot;: @&quot;cc&quot;&#125;;</span><br><span class="line">    NSString* p2 &#x3D; @&quot;param_p2&quot;;</span><br><span class="line">    NSString* p3 &#x3D; @&quot;param_p3&quot;;</span><br><span class="line">    NSArray* nativeParams &#x3D; @[p1, p2, p3];</span><br><span class="line">    &#x2F;&#x2F;执行h5回调函数</span><br><span class="line">    [_callback executeWithParams:nativeParams completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">        NSLog(@&quot;completionHandler&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>初始化webView</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    self.view.backgroundColor &#x3D; [UIColor lightGrayColor];</span><br><span class="line">    </span><br><span class="line">    CGRect rect &#x3D; CGRectMake(0, 0, self.view.bounds.size.width, self.view.bounds.size.height-150);</span><br><span class="line">    self.webView &#x3D; [[WKJSWebView alloc] initWithFrame:rect configuration:[WKWebViewConfiguration new] scripts:nil withJavascriptInterfaces:@&#123;@&quot;native&quot;:[JSInterface new]&#125;];</span><br><span class="line">    self.webView.navigationDelegate &#x3D; self;</span><br><span class="line">   [self.view addSubview:self.webView];</span><br><span class="line">    </span><br><span class="line">    NSString* _urlStr &#x3D; [[NSBundle mainBundle] pathForResource:@&quot;index&quot; ofType:@&quot;html&quot;];</span><br><span class="line">    NSURLRequest* request &#x3D; [NSURLRequest requestWithURL:[NSURL fileURLWithPath:_urlStr]];</span><br><span class="line">    [self.webView loadRequest:request];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>JS调原生接口</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// js</span></span></span><br><span class="line"><span class="javascript">  <span class="built_in">window</span>.native.testWithParamscallback(<span class="string">'abc'</span>, (p1, p2, p3) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(p1, p2, p3);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> obj1 = <span class="built_in">JSON</span>.parse(p1); </span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"op"</span>);</span></span><br><span class="line">      div.innerHTML = obj1.letter;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="原生调JS"><a href="#原生调JS" class="headerlink" title="原生调JS"></a>原生调JS</h3><ol>
<li>js注册方法</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// js</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">changeColor</span><span class="params">(param)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"oi"</span>);</span></span><br><span class="line">      div.style.backgroundColor = param.color;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="javascript">  <span class="built_in">window</span>.EasyJS.mount(<span class="string">"divChangeColor"</span>, changeColor);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>原生调用JS</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">NSDictionary* args &#x3D; @&#123;@&quot;color&quot;: [self Ox_randomColor]&#125;;</span><br><span class="line">[self.webView invokeJSFunction:@&quot;divChangeColor&quot; params:args completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;原生调用JS方法完成.&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>



<h2 id="二-原理解析"><a href="#二-原理解析" class="headerlink" title="二. 原理解析"></a>二. 原理解析</h2><p>基本思想就是将需要交互的接口挂载到浏览器的window上, 然后通过js代码调用.</p>
<p>原生将js代码编译成字符串, 再通过下面的方法执行js:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;</span><br></pre></td></tr></table></figure>



<h3 id="js调原生"><a href="#js调原生" class="headerlink" title="js调原生"></a>js调原生</h3><h4 id="注入桥接js"><a href="#注入桥接js" class="headerlink" title="注入桥接js"></a>注入桥接js</h4><p>首先看下面的js代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">!<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.EasyJS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">window</span>.EasyJS = &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 存放JS的回调函数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        __callbacks: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 存放JS注册给native的方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        __events: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * JS执行此方法,将JS函数挂载到__events供原生调用</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>funcName js方法名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>handler js方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mount: <span class="function"><span class="keyword">function</span> (<span class="params">funcName, handler</span>) </span>&#123;</span><br><span class="line">            EasyJS.__events[funcName] = handler;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 原生执行此方法 调用JS函数</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>funcID js方法名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;JSON&#125;</span> </span>paramsJson 参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        invokeJS: <span class="function"><span class="keyword">function</span> (<span class="params">funcID, paramsJson</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> handler = EasyJS.__events[funcID];</span><br><span class="line">            <span class="keyword">if</span> (handler &amp;&amp; <span class="keyword">typeof</span> (handler) === <span class="string">'function'</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> args = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">JSON</span>.parse(paramsJson) == <span class="string">'object'</span>) &#123;</span><br><span class="line">                        args = <span class="built_in">JSON</span>.parse(paramsJson);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        args = paramsJson;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> handler(args);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(error);</span><br><span class="line">                    args = paramsJson;</span><br><span class="line">                    <span class="keyword">return</span> handler(args);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(funcID + <span class="string">'函数未定义'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * native通过此方法执行JS回调函数</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>cbID 函数ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;Boolean&#125;</span> </span>removeAfterExecute 执行后是否从__callbacks中否移除此回调函数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        invokeCallback: <span class="function"><span class="keyword">function</span> (<span class="params">cbID, removeAfterExecute</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">            args.shift(); <span class="comment">// __cb1577786915804</span></span><br><span class="line">            args.shift(); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = args.length; i &lt; l; i++) &#123;</span><br><span class="line">                args[i] = <span class="built_in">decodeURIComponent</span>(args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> cb = EasyJS.__callbacks[cbID];</span><br><span class="line">            <span class="keyword">if</span> (removeAfterExecute) &#123;</span><br><span class="line">                EasyJS.__callbacks[cbID] = <span class="literal">undefined</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cb.apply(<span class="literal">null</span>, args);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用原生obj对象的方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>obj </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>functionName </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;Array&#125;</span> </span>args </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        call: <span class="function"><span class="keyword">function</span> (<span class="params">obj, functionName, args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> formattedArgs = [];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = args.length; i &lt; l; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> args[i] == <span class="string">'function'</span>) &#123;</span><br><span class="line">                    formattedArgs.push(<span class="string">'f'</span>);</span><br><span class="line">                    <span class="keyword">let</span> cbID = <span class="string">'__cb'</span> + (+<span class="keyword">new</span> <span class="built_in">Date</span>) + <span class="built_in">Math</span>.random();</span><br><span class="line">                    EasyJS.__callbacks[cbID] = args[i];</span><br><span class="line">                    formattedArgs.push(cbID);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    formattedArgs.push(<span class="string">'s'</span>);</span><br><span class="line">                    formattedArgs.push(<span class="built_in">encodeURIComponent</span>(args[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> argStr = (formattedArgs.length &gt; <span class="number">0</span> ? <span class="string">':'</span> + <span class="built_in">encodeURIComponent</span>(formattedArgs.join(<span class="string">':'</span>)) : <span class="string">''</span>);</span><br><span class="line">            <span class="comment">/** NativeListener 要与原生中addScriptMessageHandler的name保持一致 */</span></span><br><span class="line">            <span class="built_in">window</span>.webkit.messageHandlers.NativeListener.postMessage(obj + <span class="string">':'</span> + <span class="built_in">encodeURIComponent</span>(functionName) + argStr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> ret = EasyJS.retValue;</span><br><span class="line">            EasyJS.retValue = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(ret);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * native用来给window添加obj的对象与方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>obj 添加到window上的对象</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param <span class="type">&#123;Array&lt;String&gt;&#125;</span> </span>methods 添加到obj上的方法数组</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        inject: <span class="function"><span class="keyword">function</span> (<span class="params">obj, methods</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">window</span>[obj] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">let</span> jsObj = <span class="built_in">window</span>[obj];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = methods.length; i &lt; l; i++) &#123;</span><br><span class="line">                (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">let</span> method = methods[i];</span><br><span class="line">                    <span class="keyword">let</span> jsMethod = method.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">':'</span>, <span class="string">'g'</span>), <span class="string">''</span>);</span><br><span class="line">                    jsObj[jsMethod] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> EasyJS.call(obj, method, <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;)();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>这段js在webView初始化时注入到浏览器, 在window上增加一个EasyJS对象, 为交互搭建桥梁.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">&#x2F;&#x2F;EASY_JS_INJECT_STRING是上面的js代码串</span><br><span class="line">[configuration.userContentController addUserScript:[[WKUserScript alloc] initWithSource:EASY_JS_INJECT_STRING injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES]];</span><br></pre></td></tr></table></figure>



<h4 id="注入原生交互方法"><a href="#注入原生交互方法" class="headerlink" title="注入原生交互方法"></a>注入原生交互方法</h4><p>然后, 继续注入原生交互类:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">&#x2F;&#x2F; interfaces : @&#123;@&quot;native&quot;:[JSInterface new]&#125;</span><br><span class="line">    NSMutableString* injectString &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    for(NSString *key in [interfaces allKeys]) &#123;</span><br><span class="line">        [injectString appendString:@&quot;EasyJS.inject(\&quot;&quot;];</span><br><span class="line">        [injectString appendString:key];</span><br><span class="line">        [injectString appendString:@&quot;\&quot;, [&quot;];</span><br><span class="line">        NSObject* interfaceObj &#x3D; [interfaces objectForKey:key];</span><br><span class="line">        if ([interfaceObj isKindOfClass:[NSObject class]]) &#123;</span><br><span class="line">            Class cls &#x3D; object_getClass(interfaceObj);</span><br><span class="line">            while (cls !&#x3D; [NSObject class]) &#123;</span><br><span class="line">                unsigned int mc &#x3D; 0;</span><br><span class="line">                Method * mlist &#x3D; class_copyMethodList(cls, &amp;mc);</span><br><span class="line">                for (int i &#x3D; 0; i &lt; mc; i++) &#123;</span><br><span class="line">                    [injectString appendString:@&quot;\&quot;&quot;];</span><br><span class="line">                    [injectString appendString:[NSString stringWithUTF8String:sel_getName(method_getName(mlist[i]))]];</span><br><span class="line">                    [injectString appendString:@&quot;\&quot;&quot;];</span><br><span class="line">                    if ((i !&#x3D; mc - 1) || (cls.superclass !&#x3D; [NSObject class])) &#123;</span><br><span class="line">                        [injectString appendString:@&quot;, &quot;];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                free(mlist);</span><br><span class="line">                cls &#x3D; cls.superclass;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [injectString appendString:@&quot;]);&quot;]; &#x2F;&#x2F;@&quot;EasyJS.inject(\&quot;native\&quot;, [\&quot;testWithParams:callback:\&quot;]);&quot;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">    NSLog(@&quot;injectString :\n%@&quot;, injectString);</span><br><span class="line">#endif</span><br><span class="line">    [configuration.userContentController addUserScript:[[WKUserScript alloc] initWithSource:injectString injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES]];</span><br></pre></td></tr></table></figure>

<p>上面代码调用了<code>EasyJS.inject()</code>方法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">inject: <span class="function"><span class="keyword">function</span> (<span class="params">obj, methods</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">window</span>[obj] = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> jsObj = <span class="built_in">window</span>[obj];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = methods.length; i &lt; l; i++) &#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> method = methods[i];</span><br><span class="line">            <span class="keyword">let</span> jsMethod = method.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">':'</span>, <span class="string">'g'</span>), <span class="string">''</span>);</span><br><span class="line">            jsObj[jsMethod] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> EasyJS.call(obj, method, <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 在window增加native对象,并且把JSInterface的交互方法都加到native对象.这里的native相当于JSInterface在h5中的镜像, 通过native,就可以调用原生方法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line"><span class="built_in">window</span>.native.testWithParamscallback(<span class="string">'abc'</span>, (p1, p2, p3) =&gt; &#123;</span><br><span class="line">    <span class="comment">// h5回调函数</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="发送消息给原生"><a href="#发送消息给原生" class="headerlink" title="发送消息给原生"></a>发送消息给原生</h4><p>但是, native.testWithParamscallback长这样的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> EasyJS.call(obj, method, <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这是镜像native的testWithParamscallback方法, 它并不能换起原生, 真正调用原生的是<code>EasyJS.call()</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">call: <span class="function"><span class="keyword">function</span> (<span class="params">obj, functionName, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> formattedArgs = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = args.length; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> args[i] == <span class="string">'function'</span>) &#123;</span><br><span class="line">            formattedArgs.push(<span class="string">'f'</span>);</span><br><span class="line">            <span class="keyword">let</span> cbID = <span class="string">'__cb'</span> + (+<span class="keyword">new</span> <span class="built_in">Date</span>) + <span class="built_in">Math</span>.random();</span><br><span class="line">            EasyJS.__callbacks[cbID] = args[i];</span><br><span class="line">            formattedArgs.push(cbID);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            formattedArgs.push(<span class="string">'s'</span>);</span><br><span class="line">            formattedArgs.push(<span class="built_in">encodeURIComponent</span>(args[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> argStr = (formattedArgs.length &gt; <span class="number">0</span> ? <span class="string">':'</span> + <span class="built_in">encodeURIComponent</span>(formattedArgs.join(<span class="string">':'</span>)) : <span class="string">''</span>);</span><br><span class="line">    <span class="comment">/** NativeListener 要与原生中addScriptMessageHandler的name保持一致 */</span></span><br><span class="line">    <span class="built_in">window</span>.webkit.messageHandlers.NativeListener.postMessage(obj + <span class="string">':'</span> + <span class="built_in">encodeURIComponent</span>(functionName) + argStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = EasyJS.retValue;</span><br><span class="line">    EasyJS.retValue = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Easy.call()</code>将js的回调函数生成唯一ID对应保存到<code>EasyJS.__callbacks</code>,再将唯一ID和参数按约定的方式编译放入数组 ,然后用原生约定的监听名字NativeListener发送消息给原生<code>window.webkit.messageHandlers.NativeListener.postMessage(obj + &#39;:&#39; + encodeURIComponent(functionName) + argStr)</code>;</p>
<p>NativeListener在初始化webView时指定, 同时将原生交互类映射interfaces挂载到监听者.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">&#x2F;&#x2F; add message handler</span><br><span class="line">WKJSListener *listener &#x3D; [[WKJSListener alloc] init];</span><br><span class="line">listener.javascriptInterfaces &#x3D; interfaces;</span><br><span class="line">[configuration.userContentController addScriptMessageHandler:listener name:WKJSMessageHandler];</span><br></pre></td></tr></table></figure>



<h4 id="原生接收消息并执行"><a href="#原生接收消息并执行" class="headerlink" title="原生接收消息并执行"></a>原生接收消息并执行</h4><p>js发出消息后, 原生的监听WKJSListener可以接收到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message &#123;</span><br><span class="line">    NSMutableArray &lt;WKJSDataFunction *&gt;* _funcs &#x3D; [NSMutableArray new];</span><br><span class="line">    NSMutableArray &lt;NSString *&gt;* _args &#x3D; [NSMutableArray new];</span><br><span class="line">    </span><br><span class="line">    if ([message.name isEqualToString:WKJSMessageHandler]) &#123;</span><br><span class="line">        __weak WKJSWebView *webView &#x3D; (WKJSWebView *)message.webView;</span><br><span class="line">        NSString *requestString &#x3D; [message body];</span><br><span class="line">        &#x2F;&#x2F; native:testWithParams%3Acallback%3A:s%3Aabc%3Af%3A__cb1577786915804</span><br><span class="line">        NSArray *components &#x3D; [requestString componentsSeparatedByString:@&quot;:&quot;];</span><br><span class="line">        &#x2F;&#x2F;NSLog(@&quot;req: %@&quot;, requestString);</span><br><span class="line">        </span><br><span class="line">        NSString* obj &#x3D; (NSString*)[components objectAtIndex:0];</span><br><span class="line">        NSString* method &#x3D; [(NSString*)[components objectAtIndex:1] stringByRemovingPercentEncoding];</span><br><span class="line">        NSObject* interface &#x3D; [self.javascriptInterfaces objectForKey:obj];</span><br><span class="line">        </span><br><span class="line">        SEL selector &#x3D; NSSelectorFromString(method);</span><br><span class="line">        NSMethodSignature* sig &#x3D; [interface methodSignatureForSelector:selector];</span><br><span class="line">        if (sig.numberOfArguments &#x3D;&#x3D; 2 &amp;&amp; components.count &gt; 2) &#123;</span><br><span class="line">            NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]: %@&quot;,NSStringFromClass([interface class]),method,@&quot;实际接收参数个数与js传参数不相等&quot;];</span><br><span class="line">            assertDesc &#x3D; assertDesc ? : @&quot;&quot;;</span><br><span class="line">            NSAssert(NO, assertDesc);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!sig) &#123;</span><br><span class="line">            NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]:%@&quot;,NSStringFromClass([interface class]),method,@&quot;method signature argument cannot be nil&quot;];</span><br><span class="line">            NSAssert(NO, assertDesc);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (![interface respondsToSelector:selector]) &#123;</span><br><span class="line">            NSAssert(NO, @&quot;该方法未实现&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        NSInvocation* invoker &#x3D; [NSInvocation invocationWithMethodSignature:sig];</span><br><span class="line">        invoker.selector &#x3D; selector;</span><br><span class="line">        invoker.target &#x3D; interface;</span><br><span class="line">        if ([components count] &gt; 2)&#123;</span><br><span class="line">            NSString *argsAsString &#x3D; [(NSString*)[components objectAtIndex:2] stringByRemovingPercentEncoding];</span><br><span class="line">            NSArray* formattedArgs &#x3D; [argsAsString componentsSeparatedByString:@&quot;:&quot;];</span><br><span class="line">            if ((sig.numberOfArguments - 2) !&#x3D; [formattedArgs count] &#x2F; 2) &#123;</span><br><span class="line">                NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]: 实际接收参数个数%@，js传参个数%@&quot;,NSStringFromClass([interface class]),method,@(sig.numberOfArguments - 2),@([formattedArgs count] &#x2F; 2)];</span><br><span class="line">                assertDesc &#x3D; assertDesc ? : @&quot;&quot;;</span><br><span class="line">                NSAssert(NO, assertDesc);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            for (unsigned long i &#x3D; 0, j &#x3D; 0, l &#x3D; [formattedArgs count]; i &lt; l; i+&#x3D;2, j++)&#123;</span><br><span class="line">                NSString* type &#x3D; ((NSString*) [formattedArgs objectAtIndex:i]);</span><br><span class="line">                NSString* argStr &#x3D; ((NSString*) [formattedArgs objectAtIndex:i + 1]);</span><br><span class="line">                </span><br><span class="line">                if ([@&quot;f&quot; isEqualToString:type])&#123;</span><br><span class="line">                    WKJSDataFunction *func &#x3D; [[WKJSDataFunction alloc] initWithWebView:webView];</span><br><span class="line">                    func.funcID &#x3D; argStr;</span><br><span class="line">                    [_funcs addObject:func];</span><br><span class="line">                    [invoker setArgument:&amp;func atIndex:(j + 2)];</span><br><span class="line">                &#125;else if ([@&quot;s&quot; isEqualToString:type])&#123;</span><br><span class="line">                    NSString* arg &#x3D; [argStr stringByRemovingPercentEncoding];</span><br><span class="line">                    [_args addObject:arg];</span><br><span class="line">                    [invoker setArgument:&amp;arg atIndex:(j + 2)];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [invoker retainArguments];</span><br><span class="line">        [invoker invoke];</span><br><span class="line">        </span><br><span class="line">        if ([sig methodReturnLength] &gt; 0)&#123;</span><br><span class="line">            __unsafe_unretained NSString* tmpRetValue;</span><br><span class="line">            [invoker getReturnValue:&amp;tmpRetValue];</span><br><span class="line">            NSString *retValue &#x3D; tmpRetValue;</span><br><span class="line">            </span><br><span class="line">            if (retValue &#x3D;&#x3D; NULL || retValue &#x3D;&#x3D; nil)&#123;</span><br><span class="line">                [webView wk_evaluateJavaScript:@&quot;EasyJS.retValue&#x3D;null;&quot; completionHandler:nil];</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                retValue &#x3D; [retValue stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet letterCharacterSet]];</span><br><span class="line">                retValue &#x3D; [@&quot;&quot; stringByAppendingFormat:@&quot;EasyJS.retValue&#x3D;\&quot;%@\&quot;;&quot;, retValue];</span><br><span class="line">                [webView wk_evaluateJavaScript:retValue completionHandler:nil];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [_funcs removeAllObjects];</span><br><span class="line">    [_args removeAllObjects];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里取出对象,方法,参数, 通过<code>javascriptInterfaces</code>映射取原生对象(也就是JSInterface),然后执行方法.</p>
<h4 id="执行js回调"><a href="#执行js回调" class="headerlink" title="执行js回调"></a>执行js回调</h4><p>原生方法执行后回调js:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">[_callback executeWithParams:nativeParams completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p><code>executeWithParams:completionHandler:</code>方法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">- (void)executeWithParams:(NSArray *)params completionHandler:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    NSMutableArray * args &#x3D; [NSMutableArray arrayWithArray:params];</span><br><span class="line">    for (int i&#x3D;0; i&lt;params.count; i++) &#123;</span><br><span class="line">        NSString* json &#x3D; [params[i] mj_JSONString];</span><br><span class="line">        [args replaceObjectAtIndex:i withObject:json];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSMutableString* injection &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    [injection appendFormat:@&quot;EasyJS.invokeCallback(\&quot;%@\&quot;, %@&quot;, self.funcID, self.removeAfterExecute ? @&quot;true&quot; : @&quot;false&quot;];</span><br><span class="line">    </span><br><span class="line">    if (args) &#123;</span><br><span class="line">        for (unsigned long i &#x3D; 0, l &#x3D; args.count; i &lt; l; i++)&#123;</span><br><span class="line">            NSString* arg &#x3D; [args objectAtIndex:i];</span><br><span class="line">            NSCharacterSet *chars &#x3D; [NSCharacterSet characterSetWithCharactersInString:@&quot;!*&#39;();:@&amp;&#x3D;+$,&#x2F;?%#[]&quot;];</span><br><span class="line">            NSString *encodedArg &#x3D; [arg stringByAddingPercentEncodingWithAllowedCharacters:chars];</span><br><span class="line">            [injection appendFormat:@&quot;, \&quot;%@\&quot;&quot;, encodedArg];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [injection appendString:@&quot;);&quot;];</span><br><span class="line">    </span><br><span class="line">    if (_webView)&#123;</span><br><span class="line">        [_webView wk_evaluateJavaScript:injection completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">            if (completionHandler) &#123;completionHandler(response, error);&#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>EasyJS.invokeCallback()</code>传入回调函数唯一ID, 取出<code>__callbacks</code>中对应的方法并执行:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">invokeCallback: <span class="function"><span class="keyword">function</span> (<span class="params">cbID, removeAfterExecute</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">    args.shift(); <span class="comment">// __cb1577786915804</span></span><br><span class="line">    args.shift(); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = args.length; i &lt; l; i++) &#123;</span><br><span class="line">        args[i] = <span class="built_in">decodeURIComponent</span>(args[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cb = EasyJS.__callbacks[cbID];</span><br><span class="line">    <span class="keyword">if</span> (removeAfterExecute) &#123;</span><br><span class="line">        EasyJS.__callbacks[cbID] = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cb.apply(<span class="literal">null</span>, args);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><code>args.shift()</code>移除多余的参数.</p>
<p>至此, js调原生流程结束.</p>
<h3 id="原生调js"><a href="#原生调js" class="headerlink" title="原生调js"></a>原生调js</h3><h4 id="js注册函数"><a href="#js注册函数" class="headerlink" title="js注册函数"></a>js注册函数</h4><p>原生调用js, 需要js将方法注册到window, 注入js中提供了<code>mount()</code>方法给js注册函数用:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">mount: <span class="function"><span class="keyword">function</span> (<span class="params">funcName, handler</span>) </span>&#123;</span><br><span class="line">    EasyJS.__events[funcName] = handler;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><code>mount()</code>方法将JS函数handler存放到__events, 以便提供给原生调用.</p>
<p>js中注册也很简单:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line"><span class="built_in">window</span>.EasyJS.mount(<span class="string">"divChangeColor"</span>, changeColor);</span><br></pre></td></tr></table></figure>

<p>这样就将<code>divChangeColor</code>函数注册了, 它对应js中的<code>changeColor()</code>方法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeColor</span>(<span class="params">param</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"oi"</span>);</span><br><span class="line">    div.style.backgroundColor = param.color;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="原生调js-1"><a href="#原生调js-1" class="headerlink" title="原生调js"></a>原生调js</h4><p>原生调用js函数<code>divChangeColor</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">[self.webView invokeJSFunction:@&quot;divChangeColor&quot; params:@&#123;@&quot;color&quot;: [self Ox_randomColor]&#125; completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;原生调用JS方法完成.&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p><code>invokeJSFunction:params:completionHandler:</code>方法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OC</span><br><span class="line">- (void)invokeJSFunction:(NSString*)jsFuncName params:(id)params completionHandler:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    NSString *paramJson &#x3D; @&quot;&quot;;</span><br><span class="line">    if (params) &#123;  paramJson &#x3D; [params mj_JSONString]; &#125;</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\\&quot; withString:@&quot;\\\\&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\&quot;&quot; withString:@&quot;\\\&quot;&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\\n&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\r&quot; withString:@&quot;\\r&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\f&quot; withString:@&quot;\\f&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\u2028&quot; withString:@&quot;\\u2028&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\u2029&quot; withString:@&quot;\\u2029&quot;];</span><br><span class="line">    </span><br><span class="line">    NSString *script &#x3D; [NSString stringWithFormat:@&quot;%@(&#39;%@&#39;, &#39;%@&#39;)&quot;, @&quot;window.EasyJS.invokeJS&quot;, jsFuncName,  paramJson];</span><br><span class="line">    [self wk_evaluateJavaScript:script completionHandler:completionHandler];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>EasyJS.invokeJS()</code>,取出<code>__events</code>中对应<code>divChangeColor</code>的函数并执行.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js</span></span><br><span class="line">invokeJS: <span class="function"><span class="keyword">function</span> (<span class="params">funcID, paramsJson</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> handler = EasyJS.__events[funcID];</span><br><span class="line">    <span class="keyword">if</span> (handler &amp;&amp; <span class="keyword">typeof</span> (handler) === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> args = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">JSON</span>.parse(paramsJson) == <span class="string">'object'</span>) &#123;</span><br><span class="line">                args = <span class="built_in">JSON</span>.parse(paramsJson);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                args = paramsJson;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> handler(args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(error);</span><br><span class="line">            args = paramsJson;</span><br><span class="line">            <span class="keyword">return</span> handler(args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(funcID + <span class="string">'函数未定义'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>至此, 原生调用js完成.</p>
<h2 id="三-WKJSWebView代码"><a href="#三-WKJSWebView代码" class="headerlink" title="三. WKJSWebView代码"></a>三. WKJSWebView代码</h2><h3 id="WKJSWebView-h"><a href="#WKJSWebView-h" class="headerlink" title="WKJSWebView.h"></a>WKJSWebView.h</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;WebKit&#x2F;WebKit.h&gt;</span><br><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSWebView</span><br><span class="line"></span><br><span class="line">@interface WKJSWebView : WKWebView</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame configuration:(WKWebViewConfiguration*)configuration scripts:(NSArray&lt;NSString*&gt;*)scripts withJavascriptInterfaces:(NSDictionary*)interfaces;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; 主线程执行js</span><br><span class="line">- (void)wk_evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^)(id, NSError *))completionHandler;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; native 调用 h5 方法</span><br><span class="line">- (void)invokeJSFunction:(NSString*)jsFuncName params:(id)params completionHandler:(void (^)(id response, NSError *error))completionHandler;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSListener</span><br><span class="line"></span><br><span class="line">@interface WKJSListener : NSObject&lt;WKNavigationDelegate,WKScriptMessageHandler&gt;</span><br><span class="line">@property (nonatomic) NSDictionary *javascriptInterfaces;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSDataFunction</span><br><span class="line"></span><br><span class="line">@interface WKJSDataFunction : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString* funcID;</span><br><span class="line">@property (nonatomic, strong) WKJSWebView *webView;</span><br><span class="line">@property (nonatomic, assign) BOOL removeAfterExecute;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithWebView:(WKJSWebView*)webView;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 回调JS</span><br><span class="line">- (void)execute:(void (^)(id response, NSError* error))completionHandler;</span><br><span class="line">- (void)executeWithParam:(NSString *)param completionHandler:(void (^)(id response, NSError* error))completionHandler;</span><br><span class="line">- (void)executeWithParams:(NSArray *)params completionHandler:(void (^)(id response, NSError* error))completionHandler;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>



<h3 id="WKJSWebView-m"><a href="#WKJSWebView-m" class="headerlink" title="WKJSWebView.m"></a>WKJSWebView.m</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;WKJSWebView.h&quot;</span><br><span class="line">#import &lt;objc&#x2F;runtime.h&gt;</span><br><span class="line">#import &quot;MJExtension.h&quot;</span><br><span class="line"></span><br><span class="line">static NSString * const EASY_JS_INJECT_STRING &#x3D; @&quot;!function () &#123;\</span><br><span class="line">    if (window.EasyJS) &#123;\</span><br><span class="line">        return;\</span><br><span class="line">    &#125;\</span><br><span class="line">    window.EasyJS &#x3D; &#123;\</span><br><span class="line">        __callbacks: &#123;&#125;,\</span><br><span class="line">        __events: &#123;&#125;,\</span><br><span class="line">        mount: function (funcName, handler) &#123;\</span><br><span class="line">            EasyJS.__events[funcName] &#x3D; handler;\</span><br><span class="line">        &#125;,\</span><br><span class="line">        invokeJS: function (funcID, paramsJson) &#123;\</span><br><span class="line">            let handler &#x3D; EasyJS.__events[funcID];\</span><br><span class="line">            if (handler &amp;&amp; typeof (handler) &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;\</span><br><span class="line">                let args &#x3D; &#39;&#39;;\</span><br><span class="line">                try &#123;\</span><br><span class="line">                    if (typeof JSON.parse(paramsJson) &#x3D;&#x3D; &#39;object&#39;) &#123;\</span><br><span class="line">                        args &#x3D; JSON.parse(paramsJson);\</span><br><span class="line">                    &#125; else &#123;\</span><br><span class="line">                        args &#x3D; paramsJson;\</span><br><span class="line">                    &#125;\</span><br><span class="line">                    return handler(args);\</span><br><span class="line">                &#125; catch (error) &#123;\</span><br><span class="line">                    console.log(error);\</span><br><span class="line">                    args &#x3D; paramsJson;\</span><br><span class="line">                    return handler(args);\</span><br><span class="line">                &#125;\</span><br><span class="line">            &#125; else &#123;\</span><br><span class="line">               console.log(funcID + &#39;函数未定义&#39;);\</span><br><span class="line">            &#125;\</span><br><span class="line">        &#125;,\</span><br><span class="line">        invokeCallback: function (cbID, removeAfterExecute) &#123;\</span><br><span class="line">            let args &#x3D; Array.prototype.slice.call(arguments);\</span><br><span class="line">            args.shift();\</span><br><span class="line">            args.shift();\</span><br><span class="line">            for (let i &#x3D; 0, l &#x3D; args.length; i &lt; l; i++) &#123;\</span><br><span class="line">                args[i] &#x3D; decodeURIComponent(args[i]);\</span><br><span class="line">            &#125;\</span><br><span class="line">            let cb &#x3D; EasyJS.__callbacks[cbID];\</span><br><span class="line">            if (removeAfterExecute) &#123;\</span><br><span class="line">                EasyJS.__callbacks[cbID] &#x3D; undefined;\</span><br><span class="line">            &#125;\</span><br><span class="line">            return cb.apply(null, args);\</span><br><span class="line">        &#125;,\</span><br><span class="line">        call: function (obj, functionName, args) &#123;\</span><br><span class="line">            let formattedArgs &#x3D; [];\</span><br><span class="line">            for (let i &#x3D; 0, l &#x3D; args.length; i &lt; l; i++) &#123;\</span><br><span class="line">                if (typeof args[i] &#x3D;&#x3D; &#39;function&#39;) &#123;\</span><br><span class="line">                    formattedArgs.push(&#39;f&#39;);\</span><br><span class="line">                    let cbID &#x3D; &#39;__cb&#39; + (+new Date) + Math.random();\</span><br><span class="line">                    EasyJS.__callbacks[cbID] &#x3D; args[i];\</span><br><span class="line">                    formattedArgs.push(cbID);\</span><br><span class="line">                &#125; else &#123;\</span><br><span class="line">                    formattedArgs.push(&#39;s&#39;);\</span><br><span class="line">                    formattedArgs.push(encodeURIComponent(args[i]));\</span><br><span class="line">                &#125;\</span><br><span class="line">            &#125;\</span><br><span class="line">            let argStr &#x3D; (formattedArgs.length &gt; 0 ? &#39;:&#39; + encodeURIComponent(formattedArgs.join(&#39;:&#39;)) : &#39;&#39;);\</span><br><span class="line">            window.webkit.messageHandlers.NativeListener.postMessage(obj + &#39;:&#39; + encodeURIComponent(functionName) + argStr);\</span><br><span class="line">            let ret &#x3D; EasyJS.retValue;\</span><br><span class="line">            EasyJS.retValue &#x3D; undefined;\</span><br><span class="line">            if (ret) &#123;\</span><br><span class="line">                return decodeURIComponent(ret);\</span><br><span class="line">            &#125;\</span><br><span class="line">        &#125;,\</span><br><span class="line">        inject: function (obj, methods) &#123;\</span><br><span class="line">            window[obj] &#x3D; &#123;&#125;;\</span><br><span class="line">            let jsObj &#x3D; window[obj];\</span><br><span class="line">            for (let i &#x3D; 0, l &#x3D; methods.length; i &lt; l; i++) &#123;\</span><br><span class="line">                (function () &#123;\</span><br><span class="line">                    let method &#x3D; methods[i];\</span><br><span class="line">                    let jsMethod &#x3D; method.replace(new RegExp(&#39;:&#39;, &#39;g&#39;), &#39;&#39;);\</span><br><span class="line">                    jsObj[jsMethod] &#x3D; function () &#123;\</span><br><span class="line">                        return EasyJS.call(obj, method, Array.prototype.slice.call(arguments));\</span><br><span class="line">                    &#125;;\</span><br><span class="line">                &#125;)();\</span><br><span class="line">            &#125;\</span><br><span class="line">        &#125;\</span><br><span class="line">    &#125;;\</span><br><span class="line">&#125;()&quot;;</span><br><span class="line"></span><br><span class="line">static NSString * const WKJSMessageHandler &#x3D; @&quot;NativeListener&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSWebView</span><br><span class="line"></span><br><span class="line">@implementation WKJSWebView</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 初始化WKWwebView,并将交互类的方法注入JS</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame configuration:(WKWebViewConfiguration*)configuration scripts:(NSArray&lt;NSString*&gt;*)scripts withJavascriptInterfaces:(NSDictionary*)interfaces</span><br><span class="line">&#123;</span><br><span class="line">    if (!configuration) &#123;</span><br><span class="line">        configuration &#x3D; [[WKWebViewConfiguration alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    if (!configuration.userContentController) &#123;</span><br><span class="line">        configuration.userContentController &#x3D; [[WKUserContentController alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; add script</span><br><span class="line">    for (NSString* script in scripts) &#123;</span><br><span class="line">        [configuration.userContentController addUserScript:[[WKUserScript alloc] initWithSource:script injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [configuration.userContentController addUserScript:[[WKUserScript alloc] initWithSource:EASY_JS_INJECT_STRING injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES]];</span><br><span class="line">    </span><br><span class="line">    NSMutableString* injectString &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    for(NSString *key in [interfaces allKeys]) &#123;</span><br><span class="line">        [injectString appendString:@&quot;EasyJS.inject(\&quot;&quot;];</span><br><span class="line">        [injectString appendString:key];</span><br><span class="line">        [injectString appendString:@&quot;\&quot;, [&quot;];</span><br><span class="line">        NSObject* interfaceObj &#x3D; [interfaces objectForKey:key];</span><br><span class="line">        if ([interfaceObj isKindOfClass:[NSObject class]]) &#123;</span><br><span class="line">            Class cls &#x3D; object_getClass(interfaceObj);</span><br><span class="line">            while (cls !&#x3D; [NSObject class]) &#123;</span><br><span class="line">                unsigned int mc &#x3D; 0;</span><br><span class="line">                Method * mlist &#x3D; class_copyMethodList(cls, &amp;mc);</span><br><span class="line">                for (int i &#x3D; 0; i &lt; mc; i++) &#123;</span><br><span class="line">                    [injectString appendString:@&quot;\&quot;&quot;];</span><br><span class="line">                    [injectString appendString:[NSString stringWithUTF8String:sel_getName(method_getName(mlist[i]))]];</span><br><span class="line">                    [injectString appendString:@&quot;\&quot;&quot;];</span><br><span class="line">                    if ((i !&#x3D; mc - 1) || (cls.superclass !&#x3D; [NSObject class])) &#123;</span><br><span class="line">                        [injectString appendString:@&quot;, &quot;];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                free(mlist);</span><br><span class="line">                cls &#x3D; cls.superclass;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [injectString appendString:@&quot;]);&quot;]; &#x2F;&#x2F;@&quot;EasyJS.inject(\&quot;native\&quot;, [\&quot;testWithParams:callback:\&quot;]);&quot;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">    NSLog(@&quot;injectString :\n%@&quot;, injectString);</span><br><span class="line">#endif</span><br><span class="line">    [configuration.userContentController addUserScript:[[WKUserScript alloc] initWithSource:injectString injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES]];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; add message handler</span><br><span class="line">    WKJSListener *listener &#x3D; [[WKJSListener alloc] init];</span><br><span class="line">    listener.javascriptInterfaces &#x3D; interfaces;</span><br><span class="line">    [configuration.userContentController addScriptMessageHandler:listener name:WKJSMessageHandler];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; init</span><br><span class="line">    self &#x3D; [super initWithFrame:frame configuration:configuration];</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)wk_evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^)(id, NSError *))completionHandler &#123;</span><br><span class="line">    if (![NSThread isMainThread]) &#123;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [self evaluateJavaScript:javaScriptString completionHandler:^(id _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">                if (completionHandler) &#123;completionHandler(response, error);&#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [self evaluateJavaScript:javaScriptString completionHandler:^(id _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">            if (completionHandler) &#123;completionHandler(response, error);&#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)invokeJSFunction:(NSString*)jsFuncName params:(id)params completionHandler:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    NSString *paramJson &#x3D; @&quot;&quot;;</span><br><span class="line">    if (params) &#123;  paramJson &#x3D; [params mj_JSONString]; &#125;</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\\&quot; withString:@&quot;\\\\&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\&quot;&quot; withString:@&quot;\\\&quot;&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\\n&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\r&quot; withString:@&quot;\\r&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\f&quot; withString:@&quot;\\f&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\u2028&quot; withString:@&quot;\\u2028&quot;];</span><br><span class="line">     paramJson &#x3D; [paramJson stringByReplacingOccurrencesOfString:@&quot;\u2029&quot; withString:@&quot;\\u2029&quot;];</span><br><span class="line">    </span><br><span class="line">    NSString *script &#x3D; [NSString stringWithFormat:@&quot;%@(&#39;%@&#39;, &#39;%@&#39;)&quot;, @&quot;window.EasyJS.invokeJS&quot;, jsFuncName,  paramJson];</span><br><span class="line">    [self wk_evaluateJavaScript:script completionHandler:completionHandler];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSListener</span><br><span class="line"></span><br><span class="line">@implementation WKJSListener</span><br><span class="line"></span><br><span class="line">- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message &#123;</span><br><span class="line">    NSMutableArray &lt;WKJSDataFunction *&gt;* _funcs &#x3D; [NSMutableArray new];</span><br><span class="line">    NSMutableArray &lt;NSString *&gt;* _args &#x3D; [NSMutableArray new];</span><br><span class="line">    </span><br><span class="line">    if ([message.name isEqualToString:WKJSMessageHandler]) &#123;</span><br><span class="line">        __weak WKJSWebView *webView &#x3D; (WKJSWebView *)message.webView;</span><br><span class="line">        NSString *requestString &#x3D; [message body];</span><br><span class="line">        &#x2F;&#x2F; native:testWithParams%3Acallback%3A:s%3Aabc%3Af%3A__cb1577786915804</span><br><span class="line">        NSArray *components &#x3D; [requestString componentsSeparatedByString:@&quot;:&quot;];</span><br><span class="line">        &#x2F;&#x2F;NSLog(@&quot;req: %@&quot;, requestString);</span><br><span class="line">        </span><br><span class="line">        NSString* obj &#x3D; (NSString*)[components objectAtIndex:0];</span><br><span class="line">        NSString* method &#x3D; [(NSString*)[components objectAtIndex:1] stringByRemovingPercentEncoding];</span><br><span class="line">        NSObject* interface &#x3D; [self.javascriptInterfaces objectForKey:obj];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; execute the interfacing method</span><br><span class="line">        SEL selector &#x3D; NSSelectorFromString(method);</span><br><span class="line">        NSMethodSignature* sig &#x3D; [interface methodSignatureForSelector:selector];</span><br><span class="line">        if (sig.numberOfArguments &#x3D;&#x3D; 2 &amp;&amp; components.count &gt; 2) &#123;</span><br><span class="line">            &#x2F;&#x2F; 方法签名获取到实际实现的方法无参数 &amp;&amp; js调用的方法带参数</span><br><span class="line">            NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]: %@&quot;,NSStringFromClass([interface class]),method,@&quot;oc的交互方法不带参数，但是js调用的方法传了参数&quot;];</span><br><span class="line">            &#x2F;&#x2F;  因为pod报警告，所以加上这句，实际没有意义</span><br><span class="line">            assertDesc &#x3D; assertDesc ? : @&quot;&quot;;</span><br><span class="line">            NSAssert(NO, assertDesc);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!sig) &#123;</span><br><span class="line">            NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]:%@&quot;,NSStringFromClass([interface class]),method,@&quot;method signature argument cannot be nil&quot;];</span><br><span class="line">            NSAssert(NO, assertDesc);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (![interface respondsToSelector:selector]) &#123;</span><br><span class="line">            NSAssert(NO, @&quot;该方法未实现&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        NSInvocation* invoker &#x3D; [NSInvocation invocationWithMethodSignature:sig];</span><br><span class="line">        invoker.selector &#x3D; selector;</span><br><span class="line">        invoker.target &#x3D; interface;</span><br><span class="line">        if ([components count] &gt; 2)&#123;</span><br><span class="line">            NSString *argsAsString &#x3D; [(NSString*)[components objectAtIndex:2] stringByRemovingPercentEncoding];</span><br><span class="line">            NSArray* formattedArgs &#x3D; [argsAsString componentsSeparatedByString:@&quot;:&quot;];</span><br><span class="line">            if ((sig.numberOfArguments - 2) !&#x3D; [formattedArgs count] &#x2F; 2) &#123;</span><br><span class="line">                &#x2F;&#x2F; 方法签名获取到实际实现的方法的参数个数 !&#x3D; js调用方法时传参个数</span><br><span class="line">                NSString *assertDesc &#x3D; [NSString stringWithFormat:@&quot;*** -[%@ %@]: oc的交互方法参数个数%@，js调用方法时传参个数%@&quot;,NSStringFromClass([interface class]),method,@(sig.numberOfArguments - 2),@([formattedArgs count] &#x2F; 2)];</span><br><span class="line">                &#x2F;&#x2F;  因为pod报警告，所以加上这句，实际没有意义</span><br><span class="line">                assertDesc &#x3D; assertDesc ? : @&quot;&quot;;</span><br><span class="line">                NSAssert(NO, assertDesc);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            for (unsigned long i &#x3D; 0, j &#x3D; 0, l &#x3D; [formattedArgs count]; i &lt; l; i+&#x3D;2, j++)&#123;</span><br><span class="line">                NSString* type &#x3D; ((NSString*) [formattedArgs objectAtIndex:i]);</span><br><span class="line">                NSString* argStr &#x3D; ((NSString*) [formattedArgs objectAtIndex:i + 1]);</span><br><span class="line">                </span><br><span class="line">                if ([@&quot;f&quot; isEqualToString:type])&#123;</span><br><span class="line">                    WKJSDataFunction *func &#x3D; [[WKJSDataFunction alloc] initWithWebView:webView];</span><br><span class="line">                    func.funcID &#x3D; argStr;</span><br><span class="line">                    &#x2F;&#x2F;do this to force retain a reference to it</span><br><span class="line">                    [_funcs addObject:func];</span><br><span class="line">                    [invoker setArgument:&amp;func atIndex:(j + 2)];</span><br><span class="line">                &#125;else if ([@&quot;s&quot; isEqualToString:type])&#123;</span><br><span class="line">                    NSString* arg &#x3D; [argStr stringByRemovingPercentEncoding];</span><br><span class="line">                    &#x2F;&#x2F;do this to force retain a reference to it</span><br><span class="line">                    [_args addObject:arg];</span><br><span class="line">                    [invoker setArgument:&amp;arg atIndex:(j + 2)];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [invoker retainArguments];</span><br><span class="line">        [invoker invoke];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;return the value by using javascript</span><br><span class="line">        if ([sig methodReturnLength] &gt; 0)&#123;</span><br><span class="line">            __unsafe_unretained NSString* tmpRetValue;</span><br><span class="line">            [invoker getReturnValue:&amp;tmpRetValue];</span><br><span class="line">            NSString *retValue &#x3D; tmpRetValue;</span><br><span class="line">            </span><br><span class="line">            if (retValue &#x3D;&#x3D; NULL || retValue &#x3D;&#x3D; nil)&#123;</span><br><span class="line">                [webView wk_evaluateJavaScript:@&quot;EasyJS.retValue&#x3D;null;&quot; completionHandler:nil];</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                retValue &#x3D; [retValue stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet letterCharacterSet]];</span><br><span class="line">                retValue &#x3D; [@&quot;&quot; stringByAppendingFormat:@&quot;EasyJS.retValue&#x3D;\&quot;%@\&quot;;&quot;, retValue];</span><br><span class="line">                [webView wk_evaluateJavaScript:retValue completionHandler:nil];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;clean up any retained funcs</span><br><span class="line">    [_funcs removeAllObjects];</span><br><span class="line">    &#x2F;&#x2F;clean up any retained args</span><br><span class="line">    [_args removeAllObjects];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#pragma mark - WKJSDataFunction</span><br><span class="line"></span><br><span class="line">@implementation WKJSDataFunction</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithWebView:(WKJSWebView *)webView &#123;</span><br><span class="line">    self &#x3D; [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        _webView &#x3D; webView;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)execute:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    [self executeWithParam:nil completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">        if (completionHandler) &#123;</span><br><span class="line">            completionHandler(response, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)executeWithParam:(NSString *)param completionHandler:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    [self executeWithParams:param ? @[param] : nil completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">        if (completionHandler) &#123;</span><br><span class="line">            completionHandler(response, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)executeWithParams:(NSArray *)params completionHandler:(void (^)(id response, NSError *error))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    NSMutableArray * args &#x3D; [NSMutableArray arrayWithArray:params];</span><br><span class="line">    for (int i&#x3D;0; i&lt;params.count; i++) &#123;</span><br><span class="line">        NSString* json &#x3D; [params[i] mj_JSONString];</span><br><span class="line">        [args replaceObjectAtIndex:i withObject:json];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSMutableString* injection &#x3D; [[NSMutableString alloc] init];</span><br><span class="line">    [injection appendFormat:@&quot;EasyJS.invokeCallback(\&quot;%@\&quot;, %@&quot;, self.funcID, self.removeAfterExecute ? @&quot;true&quot; : @&quot;false&quot;];</span><br><span class="line">    </span><br><span class="line">    if (args) &#123;</span><br><span class="line">        for (unsigned long i &#x3D; 0, l &#x3D; args.count; i &lt; l; i++)&#123;</span><br><span class="line">            NSString* arg &#x3D; [args objectAtIndex:i];</span><br><span class="line">            NSCharacterSet *chars &#x3D; [NSCharacterSet characterSetWithCharactersInString:@&quot;!*&#39;();:@&amp;&#x3D;+$,&#x2F;?%#[]&quot;];</span><br><span class="line">            NSString *encodedArg &#x3D; [arg stringByAddingPercentEncodingWithAllowedCharacters:chars];</span><br><span class="line">            [injection appendFormat:@&quot;, \&quot;%@\&quot;&quot;, encodedArg];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [injection appendString:@&quot;);&quot;];</span><br><span class="line">    </span><br><span class="line">    if (_webView)&#123;</span><br><span class="line">        [_webView wk_evaluateJavaScript:injection completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">            if (completionHandler) &#123;completionHandler(response, error);&#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>





<h2 id="四-demo代码"><a href="#四-demo代码" class="headerlink" title="四. demo代码"></a>四. demo代码</h2><h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  ViewController.m</span><br><span class="line">&#x2F;&#x2F;  TMEasyJSWebView</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  Created by 吉久东 on 2019&#x2F;8&#x2F;13.</span><br><span class="line">&#x2F;&#x2F;  Copyright © 2019 JIJIUDONG. All rights reserved.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &quot;WKJSWebView.h&quot;</span><br><span class="line">#import &quot;JSInterface.h&quot;</span><br><span class="line">#import &quot;MJExtension.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()&lt;WKNavigationDelegate&gt;</span><br><span class="line">@property (nonatomic, strong) WKJSWebView *webView;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    self.view.backgroundColor &#x3D; [UIColor lightGrayColor];</span><br><span class="line">    </span><br><span class="line">    CGRect rect &#x3D; CGRectMake(0, 0, self.view.bounds.size.width, self.view.bounds.size.height-150);</span><br><span class="line">    self.webView &#x3D; [[WKJSWebView alloc] initWithFrame:rect configuration:[WKWebViewConfiguration new] scripts:nil withJavascriptInterfaces:@&#123;@&quot;native&quot;:[JSInterface new]&#125;];</span><br><span class="line">    self.webView.navigationDelegate &#x3D; self;</span><br><span class="line">   [self.view addSubview:self.webView];</span><br><span class="line">    </span><br><span class="line">    NSString* _urlStr &#x3D; [[NSBundle mainBundle] pathForResource:@&quot;index&quot; ofType:@&quot;html&quot;];</span><br><span class="line">    NSURLRequest* request &#x3D; [NSURLRequest requestWithURL:[NSURL fileURLWithPath:_urlStr]];</span><br><span class="line">    [self.webView loadRequest:request];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewWillAppear:(BOOL)animated &#123;</span><br><span class="line">    [super viewWillAppear:animated];</span><br><span class="line">    </span><br><span class="line">    UILabel* l &#x3D; [UILabel new];</span><br><span class="line">    l.text &#x3D; @&quot;这里灰色部分是原生界面&quot;;</span><br><span class="line">    l.frame &#x3D; CGRectMake(5, self.view.bounds.size.height - 150, 310, 20);</span><br><span class="line">    [self.view addSubview:l];</span><br><span class="line">    </span><br><span class="line">    UIButton * b &#x3D; [UIButton buttonWithType:UIButtonTypeCustom];</span><br><span class="line">    b.backgroundColor &#x3D; [UIColor yellowColor];</span><br><span class="line">    [b setTitle:@&quot;黄色是原生按钮&quot; forState:UIControlStateNormal];</span><br><span class="line">    [b setTitleColor:[UIColor blueColor] forState:UIControlStateNormal];</span><br><span class="line">    [b setTitleColor:[UIColor redColor] forState:UIControlStateHighlighted];</span><br><span class="line">    [b addTarget:self action:@selector(nativeButtonClicked) forControlEvents:UIControlEventTouchUpInside];</span><br><span class="line">    b.frame &#x3D; CGRectMake(5, self.view.bounds.size.height-100, 310, 50);</span><br><span class="line">    [self.view addSubview:b];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)nativeButtonClicked &#123;</span><br><span class="line">    NSLog(@&quot;点击了原生按钮&quot;);</span><br><span class="line">    [self.webView invokeJSFunction:@&quot;divChangeColor&quot; params:@&#123;@&quot;color&quot;: [self Ox_randomColor]&#125; completionHandler:^(id response, NSError *error) &#123;</span><br><span class="line">        NSLog(@&quot;原生调用JS方法完成.&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMutableString*)Ox_randomColor &#123;</span><br><span class="line">    NSMutableString* color &#x3D; [[NSMutableString alloc] initWithString:@&quot;#&quot;];</span><br><span class="line">    NSArray * STRING &#x3D; @[@&quot;0&quot;,@&quot;1&quot;,@&quot;2&quot;,@&quot;3&quot;,@&quot;4&quot;,@&quot;5&quot;,@&quot;6&quot;,@&quot;7&quot;,@&quot;8&quot;,@&quot;9&quot;,@&quot;A&quot;,@&quot;B&quot;,@&quot;C&quot;,@&quot;D&quot;,@&quot;E&quot;,@&quot;F&quot;];</span><br><span class="line">    for (int i&#x3D;0; i&lt;6; i++) &#123;</span><br><span class="line">        NSInteger index &#x3D; arc4random_uniform((uint32_t)STRING.count);</span><br><span class="line">        NSString *c &#x3D; [STRING objectAtIndex:index];</span><br><span class="line">        [color appendString:c];</span><br><span class="line">    &#125;</span><br><span class="line">    return color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>



<h3 id="h5"><a href="#h5" class="headerlink" title="h5"></a>h5</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.a</span> &#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 80px;</span><br><span class="line">            font-size: 32px;</span><br><span class="line">            text-align: center;</span><br><span class="line">            line-height: 80px;</span><br><span class="line">            margin-bottom: 10px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">getCharacter</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">window</span>.native.testWithParamscallback(<span class="string">'abc'</span>, (p1, p2, p3) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(p1, p2, p3);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> obj1 = <span class="built_in">JSON</span>.parse(p1);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"op"</span>);</span></span><br><span class="line">                div.innerHTML = obj1.letter;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">changeColor</span><span class="params">(param)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"oi"</span>);</span></span><br><span class="line">            div.style.backgroundColor = param.color;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.EasyJS.mount(<span class="string">"divChangeColor"</span>, changeColor);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这里是 h5 web 页面<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>1.点击下面按钮,调用原生方法获取随机字母并显示到h5<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"op"</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">style</span>=<span class="string">"background-color: pink;"</span> <span class="attr">onclick</span>=<span class="string">"getCharacter()"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>2.原生调用h5方法,改变该元素背景色<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"oi"</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">style</span>=<span class="string">"background-color: aqua;"</span> <span class="attr">onclick</span>=<span class="string">"changeColor()"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/2019/12/04/状态栏字体颜色设置/" data-toggle="tooltip" data-placement="top" title="状态栏字体颜色设置">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/2019/07/26/随笔 - iOS获取App相关信息/" data-toggle="tooltip" data-placement="top" title="随笔 - iOS获取App相关信息">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=iOS WebView 与 JS 交互封装&body=Hi,I found this website and thought you might like it http://yoursite-url/2019/08/13/iOS WebView 与 JS 交互封装/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

<!-- gitalk start -->
<!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

<div id="gitalk-container"></div>

<!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
<script src="/js/comment/gitalk.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: '',
    id: 'Tue Aug 13 2019 17:12:31 GMT+0800', // Ensure uniqueness and length less than 50
    distractionFreeMode: false, // Facebook-like distraction free mode
    perPage: 10 ,
    pagerDirection: 'last',
    createIssueManually: false ,
    language: 'en'
  });
  gitalk.render('gitalk-container');

  var gtFolded = () => {
    setTimeout(function() {
      let markdownBody = document.getElementsByClassName("markdown-body");
      let list = Array.from(markdownBody);
      list.forEach(item => {
        if (item.clientHeight > 250) {
          item.classList.add('gt-comment-body-folded');
          item.style.maxHeight = '250px';
          item.title = 'Click to Expand';
          item.onclick = function() {
            item.classList.remove('gt-comment-body-folded');
            item.style.maxHeight = '';
            item.title = '';
            item.onclick = null;
          };
        }
      })
    }, 800);
  }
</script>

<!-- gitalk end -->



<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#一-使用方法"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">一. 使用方法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#JS调原生"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">JS调原生</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#原生调JS"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">原生调JS</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#二-原理解析"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">二. 原理解析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#js调原生"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">js调原生</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#注入桥接js"><span class="toc-nav-number">2.1.1.</span> <span class="toc-nav-text">注入桥接js</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#注入原生交互方法"><span class="toc-nav-number">2.1.2.</span> <span class="toc-nav-text">注入原生交互方法</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#发送消息给原生"><span class="toc-nav-number">2.1.3.</span> <span class="toc-nav-text">发送消息给原生</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#原生接收消息并执行"><span class="toc-nav-number">2.1.4.</span> <span class="toc-nav-text">原生接收消息并执行</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#执行js回调"><span class="toc-nav-number">2.1.5.</span> <span class="toc-nav-text">执行js回调</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#原生调js"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">原生调js</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#js注册函数"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">js注册函数</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#原生调js-1"><span class="toc-nav-number">2.2.2.</span> <span class="toc-nav-text">原生调js</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#三-WKJSWebView代码"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">三. WKJSWebView代码</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#WKJSWebView-h"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">WKJSWebView.h</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#WKJSWebView-m"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">WKJSWebView.m</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#四-demo代码"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">四. demo代码</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#iOS"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">iOS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#h5"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">h5</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    


      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#OC" title="OC">OC</a>
            
            <a class="tag" href="/tags/#JS" title="JS">JS</a>
            
            <a class="tag" href="/tags/#WebView" title="WebView">WebView</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



	<!-- Footer (contains ThemeColor、viewer) -->
	<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/jerodji">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          
            <li>
              <a target="_blank" href="http://weibo.com/吉久东">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          吉久东
          2020
          <!-- <br>
          Theme by
          <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe> -->
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->
<script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script>


  <!-- Scroll start -->
  <script type="text/javascript" src="/js/scroll.js"></script>
  <!-- Scroll end -->



  <!-- ThemeColor start -->
  <script type="text/javascript" src="/js/themecolor.js"></script>
  <!-- ThemeColor end -->





  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
  <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("http://yoursite-url/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->


	<!-- Search -->
	
	<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


	

	<!-- Image to hack wechat -->
	<!-- <img src="http://yoursite-url/img/icon_wechat.png" width="0" height="0" /> -->
	<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
